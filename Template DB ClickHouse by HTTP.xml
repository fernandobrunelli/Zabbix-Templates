<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <groups>
        <group>
            <name>Templates/Databases</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>Template DB ClickHouse by HTTP</template>
            <name>Template DB ClickHouse by HTTP</name>
            <description>Get node metrics from ClickHouse HTTP interface using HTTP agent.&#13;
&#13;
Template tooling version used: 0.35</description>
            <groups>
                <group>
                    <name>Templates/Databases</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>ClickHouse</name>
                </application>
                <application>
                    <name>ClickHouse ZooKeeper</name>
                </application>
                <application>
                    <name>Zabbix raw items</name>
                </application>
            </applications>
            <items>
                <item>
                    <name>ClickHouse: Current distribute connections</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.connections.distribute</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of connections to remote servers sending data that was INSERTed into Distributed tables.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;DistributedSend&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Current HTTP connections</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.connections.http</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of connections to HTTP server.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;HTTPConnection&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Current Interserver connections</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.connections.interserver</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of connections from other replicas to fetch parts.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;InterserverConnection&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Current MySQL connections</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.connections.mysql</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of connections to MySQL server.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;MySQLConnection&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Current TCP connections</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.connections.tcp</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of connections to TCP server (clients with native interface).</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;TCPConnection&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Get dictionaries info</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.dictionaries</key>
                    <history>0</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>Zabbix raw items</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                        </step>
                    </preprocessing>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/</url>
                    <query_fields>
                        <query_field>
                            <name>query</name>
                            <value>SELECT * FROM system.dictionaries format JSON</value>
                        </query_field>
                    </query_fields>
                    <headers>
                        <header>
                            <name>X-ClickHouse-User</name>
                            <value>{$CLICKHOUSE.USER}</value>
                        </header>
                        <header>
                            <name>X-ClickHouse-Key</name>
                            <value>{$CLICKHOUSE.PASSWORD}</value>
                        </header>
                    </headers>
                </item>
                <item>
                    <name>ClickHouse: Current distributed files to insert</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.distributed.files</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of pending files to process for asynchronous insertion into Distributed tables. Number of files for every shard is summed.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;DistributedFilesToInsert&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{min(5m)}&gt;{$CLICKHOUSE.DELAYED.FILES.DISTRIBUTED.COUNT.MAX.WARN}</expression>
                            <name>ClickHouse: Too many distributed files to insert (over {$CLICKHOUSE.DELAYED.FILES.DISTRIBUTED.COUNT.MAX.WARN} for 5 min)</name>
                            <priority>WARNING</priority>
                            <description>&quot;Clickhouse servers and &lt;remote_servers&gt; in config.xml&#13;
https://clickhouse.tech/docs/en/operations/table_engines/distributed/&quot;</description>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Distributed connection fail with retry per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.distributed.files.fail.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>&quot;Connection failures after all retries in replicated DB connection pool&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;DistributedConnectionFailAtAll&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Distributed connection fail with retry per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.distributed.files.retry.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>Connection retries in replicated DB connection pool</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;DistributedConnectionFailTry&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Delayed insert queries</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.insert.delay</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>&quot;Number of INSERT queries that are throttled due to high number of active data parts for partition in a MergeTree table.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;DelayedInserts&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{min(5m)}&gt;{$CLICKHOUSE.DELAYED.INSERTS.MAX.WARN}</expression>
                            <name>ClickHouse: Too many throttled insert queries (over {$CLICKHOUSE.DELAYED.INSERTS.MAX.WARN) for 5 min)</name>
                            <priority>WARNING</priority>
                            <description>Clickhouse have INSERT queries that are throttled due to high number of active data parts for partition in a MergeTree, please decrease INSERT frequency</description>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Inserted bytes per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.inserted_bytes.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>Bps</units>
                    <description>The number of uncompressed bytes inserted in all tables.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;InsertedBytes&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Inserted rows per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.inserted_rows.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>The number of rows inserted in all tables.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;InsertedRows&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: New INSERT queries per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.insert_query.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>Number of INSERT queries to be interpreted and potentially executed. Does not include queries that failed to parse or were rejected due to AST size limits, quota limits or limits on the number of simultaneously running queries. May include internal queries initiated by ClickHouse itself. Does not count subqueries.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;InsertQuery&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Allocated bytes</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.jemalloc.allocated</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <units>B</units>
                    <description>&quot;Total number of bytes allocated by the application.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;jemalloc.allocated&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.asynchronous_metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Mapped memory</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.jemalloc.mapped</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <units>B</units>
                    <description>&quot;Total number of bytes in active extents mapped by the allocator.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;jemalloc.mapped&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.asynchronous_metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Resident memory</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.jemalloc.resident</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <units>B</units>
                    <description>&quot;Maximum number of bytes in physically resident data pages mapped by the allocator, &#13;
comprising all pages dedicated to allocator metadata, pages backing active allocations, &#13;
and unused dirty pages.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;jemalloc.resident&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.asynchronous_metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Max count of parts per partition across all tables</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.max.part.count.for.partition</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>&quot;Clickhouse MergeTree table engine split each INSERT query to partitions (PARTITION BY expression) and add one or more PARTS per INSERT inside each partition, &#13;
after that background merge process run.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;MaxPartCountForPartition&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.asynchronous_metrics</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{min(5m)}&gt;{$CLICKHOUSE.PARTS.PER.PARTITION.WARN} * 0.9</expression>
                            <name>ClickHouse: Too many MergeTree parts (over 90% of {$CLICKHOUSE.PARTS.PER.PARTITION.WARN})</name>
                            <priority>WARNING</priority>
                            <description>&quot;Descease INSERT queries frequency.&#13;
Clickhouse MergeTree table engine split each INSERT query to partitions (PARTITION BY expression) &#13;
and add one or more PARTS per INSERT inside each partition, &#13;
after that background merge process run, and when you have too much unmerged parts inside partition, &#13;
SELECT queries performance can significate degrade, so clickhouse try delay insert, or abort it&quot;</description>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Memory used for queries</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.memory.tracking</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>B</units>
                    <description>&quot;Total amount of memory (bytes) allocated in currently executing queries.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;MemoryTracking&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Memory used for background merges</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.memory.tracking.background</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>B</units>
                    <description>&quot;Total amount of memory (bytes) allocated in background processing pool (that is dedicated for backround merges, mutations and fetches).&#13;
 Note that this value may include a drift when the memory was allocated in a context of background processing pool and freed in other context or vice-versa. This happens naturally due to caches for tables indexes and doesn't indicate memory leaks.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;MemoryTrackingInBackgroundProcessingPool&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Memory used for backround moves</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.memory.tracking.background.moves</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>B</units>
                    <description>&quot;Total amount of memory (bytes) allocated in background processing pool (that is dedicated for backround moves). Note that this value may include a drift when the memory was allocated in a context of background processing pool and freed in other context or vice-versa.&#13;
 This happens naturally due to caches for tables indexes and doesn't indicate memory leaks.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;MemoryTrackingInBackgroundMoveProcessingPool&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Memory used for merges</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.memory.tracking.merges</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>B</units>
                    <description>&quot;Total amount of memory (bytes) allocated for background merges. Included in MemoryTrackingInBackgroundProcessingPool. Note that this value may include a drift when the memory was allocated in a context of background processing pool and freed in other context or vice-versa. &#13;
This happens naturally due to caches for tables indexes and doesn't indicate memory leaks.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;MemoryTrackingForMerges&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Memory used for background schedule pool</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.memory.tracking.schedule.pool</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>B</units>
                    <description>&quot;Total amount of memory (bytes) allocated in background schedule pool (that is dedicated for bookkeeping tasks of Replicated tables).&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;MemoryTrackingInBackgroundSchedulePool&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Current running merges</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.merge.current</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of executing background merges</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;Merge&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Uncompressed bytes merged per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.merge_bytes.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>Bps</units>
                    <description>Uncompressed bytes that were read for background merges</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;MergedUncompressedBytes&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Merged rows per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.merge_rows.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>Rows read for background merges.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;MergedRows&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Network errors per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.network.error.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>Network errors (timeouts and connection failures) during query execution, background pool tasks and DNS cache update.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;NetworkErrors&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{min(5m)}&gt;{$CLICKHOUSE.NETWORK.ERRORS.MAX.WARN}</expression>
                            <name>ClickHouse: Too many network errors (over {$CLICKHOUSE.NETWORK.ERRORS.MAX.WARN} in 5m)</name>
                            <priority>WARNING</priority>
                            <description>Number of errors (timeouts and connection failures) during query execution, background pool tasks and DNS cache update is too high.</description>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Ping</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.ping</key>
                    <history>7d</history>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <valuemap>
                        <name>Service state</name>
                    </valuemap>
                    <preprocessing>
                        <step>
                            <type>REGEX</type>
                            <params>Ok\.
1</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>10m</params>
                        </step>
                    </preprocessing>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/ping</url>
                    <status_codes/>
                    <triggers>
                        <trigger>
                            <expression>{last()}=0</expression>
                            <name>ClickHouse: ClickHouse: Service is down</name>
                            <priority>AVERAGE</priority>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Longest currently running query time</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.process.elapsed</key>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>s</units>
                    <description>Get longest running query.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/</url>
                    <query_fields>
                        <query_field>
                            <name>query</name>
                            <value>SELECT max(elapsed) FROM system.processes</value>
                        </query_field>
                    </query_fields>
                    <headers>
                        <header>
                            <name>X-ClickHouse-User</name>
                            <value>{$CLICKHOUSE.USER}</value>
                        </header>
                        <header>
                            <name>X-ClickHouse-Key</name>
                            <value>{$CLICKHOUSE.PASSWORD}</value>
                        </header>
                    </headers>
                    <triggers>
                        <trigger>
                            <expression>{last()}&gt;{$CLICKHOUSE.QUERY_TIME.MAX.WARN}</expression>
                            <name>ClickHouse: There are queries running more than {$CLICKHOUSE.QUERY_TIME.MAX.WARN} seconds</name>
                            <priority>AVERAGE</priority>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Current running queries</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.query.current</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of executing queries</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;Query&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: New queries per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.query.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>Number of queries to be interpreted and potentially executed. Does not include queries that failed to parse or were rejected due to AST size limits, quota limits or limits on the number of simultaneously running queries. May include internal queries initiated by ClickHouse itself. Does not count subqueries.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.data.event == &quot;Query&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Read syscalls in fly</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.read</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of read (read, pread, io_getevents, etc.) syscalls in fly</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;Read&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Read bytes per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.read_bytes.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>Bps</units>
                    <description>&quot;Number of bytes (the number of bytes before decompression) read from compressed sources (files, network).&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;ReadCompressedBytes&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Get replicas info</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.replicas</key>
                    <history>0</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>Zabbix raw items</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                        </step>
                    </preprocessing>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/</url>
                    <query_fields>
                        <query_field>
                            <name>query</name>
                            <value>SELECT database, table, is_readonly, is_session_expired, future_parts, parts_to_check, queue_size, inserts_in_queue, merges_in_queue, log_max_index, log_pointer, total_replicas, active_replicas, log_max_index - log_pointer as replica_lag FROM system.replicas format JSON</value>
                        </query_field>
                    </query_fields>
                    <headers>
                        <header>
                            <name>X-ClickHouse-User</name>
                            <value>{$CLICKHOUSE.USER}</value>
                        </header>
                        <header>
                            <name>X-ClickHouse-Key</name>
                            <value>{$CLICKHOUSE.PASSWORD}</value>
                        </header>
                    </headers>
                </item>
                <item>
                    <name>ClickHouse: Replication lag across all tables</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.replicas.max.absolute.delay</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <units>s</units>
                    <description>Maximum replica queue delay relative to current time</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;ReplicasMaxAbsoluteDelay&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.asynchronous_metrics</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{min(5m)}&gt;{$CLICKHOUSE.REPLICA.MAX.WARN}</expression>
                            <name>ClickHouse: Replication lag is too high (over {$CLICKHOUSE.REPLICA.MAX.WARN} sec for 5min)</name>
                            <priority>WARNING</priority>
                            <description>&quot;When replica have too much lag, it can be skipped from Distributed SELECT Queries without errors &#13;
and you will have wrong query results.&quot;</description>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Total number read-only Replicas</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.replicas.readonly.total</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>&quot;Number of Replicated tables that are currently in readonly state &#13;
due to re-initialization after ZooKeeper session loss &#13;
or due to startup without ZooKeeper configured.&quot;</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;ReadonlyReplica&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Total replication tasks in queue</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.replicas.sum.queue.size</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;ReplicasSumQueueSize&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.asynchronous_metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Revision</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.revision</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Revision of the server.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;Revision&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: New SELECT queries per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.select_query.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>Number of SELECT queries to be interpreted and potentially executed. Does not include queries that failed to parse or were rejected due to AST size limits, quota limits or limits on the number of simultaneously running queries. May include internal queries initiated by ClickHouse itself. Does not count subqueries.</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;SelectQuery&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: Get system.asynchronous_metrics</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.system.asynchronous_metrics</key>
                    <history>0</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <description>Get metrics that are calculated periodically in the background</description>
                    <applications>
                        <application>
                            <name>Zabbix raw items</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                        </step>
                    </preprocessing>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/</url>
                    <query_fields>
                        <query_field>
                            <name>query</name>
                            <value>select metric, value from system.asynchronous_metrics format JSON</value>
                        </query_field>
                    </query_fields>
                    <headers>
                        <header>
                            <name>X-ClickHouse-User</name>
                            <value>{$CLICKHOUSE.USER}</value>
                        </header>
                        <header>
                            <name>X-ClickHouse-Key</name>
                            <value>{$CLICKHOUSE.PASSWORD}</value>
                        </header>
                    </headers>
                </item>
                <item>
                    <name>ClickHouse: Get system.events</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.system.events</key>
                    <history>0</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <description>Get information about the number of events that have occurred in the system.</description>
                    <applications>
                        <application>
                            <name>Zabbix raw items</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                        </step>
                    </preprocessing>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/</url>
                    <query_fields>
                        <query_field>
                            <name>query</name>
                            <value>select event, value from system.events format JSON</value>
                        </query_field>
                    </query_fields>
                    <headers>
                        <header>
                            <name>X-ClickHouse-User</name>
                            <value>{$CLICKHOUSE.USER}</value>
                        </header>
                        <header>
                            <name>X-ClickHouse-Key</name>
                            <value>{$CLICKHOUSE.PASSWORD}</value>
                        </header>
                    </headers>
                </item>
                <item>
                    <name>ClickHouse: Get system.metrics</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.system.metrics</key>
                    <history>0</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <description>Get metrics which can be calculated instantly, or have a current value format JSONEachRow</description>
                    <applications>
                        <application>
                            <name>Zabbix raw items</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                        </step>
                    </preprocessing>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/</url>
                    <query_fields>
                        <query_field>
                            <name>query</name>
                            <value>select metric, value from system.metrics format JSON</value>
                        </query_field>
                    </query_fields>
                    <headers>
                        <header>
                            <name>X-ClickHouse-User</name>
                            <value>{$CLICKHOUSE.USER}</value>
                        </header>
                        <header>
                            <name>X-ClickHouse-Key</name>
                            <value>{$CLICKHOUSE.PASSWORD}</value>
                        </header>
                    </headers>
                </item>
                <item>
                    <name>ClickHouse: Get system.settings</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.system.settings</key>
                    <history>0</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <description>Get information about settings that are currently in use.</description>
                    <applications>
                        <application>
                            <name>Zabbix raw items</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                        </step>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>1h</params>
                        </step>
                    </preprocessing>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/</url>
                    <query_fields>
                        <query_field>
                            <name>query</name>
                            <value>select name, value from system.settings format JSON</value>
                        </query_field>
                    </query_fields>
                    <headers>
                        <header>
                            <name>X-ClickHouse-User</name>
                            <value>{$CLICKHOUSE.USER}</value>
                        </header>
                        <header>
                            <name>X-ClickHouse-Key</name>
                            <value>{$CLICKHOUSE.PASSWORD}</value>
                        </header>
                    </headers>
                    <triggers>
                        <trigger>
                            <expression>{diff()}=1 and {strlen()}&gt;0</expression>
                            <name>ClickHouse: Configuration has been changed</name>
                            <priority>INFO</priority>
                            <description>ClickHouse configuration has been changed. Ack to close.</description>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Get tables info</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.tables</key>
                    <history>0</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <applications>
                        <application>
                            <name>Zabbix raw items</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.data</params>
                        </step>
                    </preprocessing>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/</url>
                    <query_fields>
                        <query_field>
                            <name>query</name>
                            <value>select database, table, sum(bytes) as bytes, count() as parts, sum(rows) as rows from system.parts where active = 1 group by database, table format JSON</value>
                        </query_field>
                    </query_fields>
                    <headers>
                        <header>
                            <name>X-ClickHouse-User</name>
                            <value>{$CLICKHOUSE.USER}</value>
                        </header>
                        <header>
                            <name>X-ClickHouse-Key</name>
                            <value>{$CLICKHOUSE.PASSWORD}</value>
                        </header>
                    </headers>
                </item>
                <item>
                    <name>ClickHouse: Uptime</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.uptime</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <units>s</units>
                    <description>Number of seconds since ClickHouse server start</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;Uptime&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.asynchronous_metrics</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{nodata(30m)}=1</expression>
                            <name>ClickHouse: Failed to fetch info data (or no data for 30m)</name>
                            <priority>WARNING</priority>
                            <description>Zabbix has not received data for items for the last 30 minutes</description>
                            <manual_close>YES</manual_close>
                            <dependencies>
                                <dependency>
                                    <name>ClickHouse: ClickHouse: Service is down</name>
                                    <expression>{Template DB ClickHouse by HTTP:clickhouse.ping.last()}=0</expression>
                                </dependency>
                            </dependencies>
                        </trigger>
                        <trigger>
                            <expression>{last()}&lt;10m</expression>
                            <name>ClickHouse: has been restarted (uptime &lt; 10m)</name>
                            <priority>INFO</priority>
                            <description>Uptime is less than 10 minutes</description>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Version</name>
                    <type>HTTP_AGENT</type>
                    <key>clickhouse.version</key>
                    <history>7d</history>
                    <trends>0</trends>
                    <value_type>CHAR</value_type>
                    <description>Version of the server</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>1d</params>
                        </step>
                    </preprocessing>
                    <url>{$CLICKHOUSE.SCHEME}://{HOST.CONN}:{$CLICKHOUSE.PORT}/</url>
                    <query_fields>
                        <query_field>
                            <name>query</name>
                            <value>SELECT version()</value>
                        </query_field>
                    </query_fields>
                    <headers>
                        <header>
                            <name>X-ClickHouse-User</name>
                            <value>{$CLICKHOUSE.USER}</value>
                        </header>
                        <header>
                            <name>X-ClickHouse-Key</name>
                            <value>{$CLICKHOUSE.PASSWORD}</value>
                        </header>
                    </headers>
                    <triggers>
                        <trigger>
                            <expression>{diff()}=1 and {strlen()}&gt;0</expression>
                            <name>ClickHouse: Version has changed (new version: {ITEM.VALUE})</name>
                            <priority>INFO</priority>
                            <description>ClickHouse version has changed. Ack to close.</description>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: Write syscalls in fly</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.write</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of write (write, pwrite, io_getevents, etc.) syscalls in fly</description>
                    <applications>
                        <application>
                            <name>ClickHouse</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;Write&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: ZooKeeper exeptions per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.zookeper.exeptions.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>Count of ZooKeeper exceptions that does not belong to user/hardware exceptions.</description>
                    <applications>
                        <application>
                            <name>ClickHouse ZooKeeper</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;ZooKeeperOtherExceptions&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: ZooKeeper hardware exeptions per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.zookeper.hw_exeptions.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>Count of ZooKeeper exceptions caused by session moved/expired, connection loss, marshalling error, operation timed out and invalid zhandle state.</description>
                    <applications>
                        <application>
                            <name>ClickHouse ZooKeeper</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;ZooKeeperHardwareExceptions&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: ZooKeeper requests</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.zookeper.request</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of requests to ZooKeeper in progress.</description>
                    <applications>
                        <application>
                            <name>ClickHouse ZooKeeper</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;ZooKeeperRequest&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: ZooKeeper sessions</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.zookeper.session</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of sessions (connections) to ZooKeeper. Should be no more than one.</description>
                    <applications>
                        <application>
                            <name>ClickHouse ZooKeeper</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;ZooKeeperSession&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                    <triggers>
                        <trigger>
                            <expression>{min(5m)}&gt;1</expression>
                            <name>ClickHouse: Too many ZooKeeper sessions opened</name>
                            <priority>WARNING</priority>
                            <description>&quot;Number of sessions (connections) to ZooKeeper. &#13;
Should be no more than one, because using more than one connection to ZooKeeper may lead to bugs due to lack of linearizability (stale reads) that ZooKeeper consistency model allows.&quot;</description>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ClickHouse: ZooKeeper user exeptions per second</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.zookeper.user_exeptions.rate</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <description>Count of ZooKeeper exceptions caused by no znodes, bad version, node exists, node empty and no children for ephemeral.</description>
                    <applications>
                        <application>
                            <name>ClickHouse ZooKeeper</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;ZooKeeperUserExceptions&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: ZooKeeper wait time</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.zookeper.wait.time</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <value_type>FLOAT</value_type>
                    <units>s</units>
                    <description>Time spent in waiting for ZooKeeper operations.</description>
                    <applications>
                        <application>
                            <name>ClickHouse ZooKeeper</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.event == &quot;ZooKeeperWaitMicroseconds&quot;)].value.first()</params>
                            <error_handler>CUSTOM_VALUE</error_handler>
                            <error_handler_params>0</error_handler_params>
                        </step>
                        <step>
                            <type>MULTIPLIER</type>
                            <params>0.000001</params>
                        </step>
                        <step>
                            <type>CHANGE_PER_SECOND</type>
                            <params/>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.events</key>
                    </master_item>
                </item>
                <item>
                    <name>ClickHouse: ZooKeeper watches</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.zookeper.watch</key>
                    <delay>0</delay>
                    <history>7d</history>
                    <description>Number of watches (e.g., event subscriptions) in ZooKeeperr.</description>
                    <applications>
                        <application>
                            <name>ClickHouse ZooKeeper</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$[?(@.metric == &quot;ZooKeeperWatch&quot;)].value.first()</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>clickhouse.system.metrics</key>
                    </master_item>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <name>Dictionaries</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.dictionaries.discovery</key>
                    <delay>0</delay>
                    <filter>
                        <evaltype>AND</evaltype>
                        <conditions>
                            <condition>
                                <macro>{#NAME}</macro>
                                <value>{$CLICKHOUSE.LLD.FILTER.DICT.MATCHES}</value>
                                <formulaid>A</formulaid>
                            </condition>
                            <condition>
                                <macro>{#NAME}</macro>
                                <value>{$CLICKHOUSE.LLD.FILTER.DICT.NOT_MATCHES}</value>
                                <operator>NOT_MATCHES_REGEX</operator>
                                <formulaid>B</formulaid>
                            </condition>
                        </conditions>
                    </filter>
                    <description>Info about dictionaries</description>
                    <item_prototypes>
                        <item_prototype>
                            <name>ClickHouse: Dictionary {#NAME}: Bytes allocated</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.dictionary.bytes_allocated[&quot;{#NAME}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <units>B</units>
                            <description>The amount of RAM the dictionary uses.</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: Dictionary &quot;{#NAME}&quot;</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.name == &quot;{#NAME}&quot;)].bytes_allocated.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.dictionaries</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: Dictionary {#NAME}: Element count</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.dictionary.element_count[&quot;{#NAME}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Number of items stored in the dictionary.</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: Dictionary &quot;{#NAME}&quot;</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.name == &quot;{#NAME}&quot;)].element_count.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.dictionaries</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: Dictionary {#NAME}: Load factor</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.dictionary.load_factor[&quot;{#NAME}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <units>%</units>
                            <description>The percentage filled in the dictionary (for a hashed dictionary, the percentage filled in the hash table).</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: Dictionary &quot;{#NAME}&quot;</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.name == &quot;{#NAME}&quot;)].bytes_allocated.first()</params>
                                </step>
                                <step>
                                    <type>MULTIPLIER</type>
                                    <params>100</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.dictionaries</key>
                            </master_item>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>clickhouse.dictionaries</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#NAME}</lld_macro>
                            <path>$.name</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                </discovery_rule>
                <discovery_rule>
                    <name>Replicas</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.replicas.discovery</key>
                    <delay>0</delay>
                    <filter>
                        <evaltype>AND</evaltype>
                        <conditions>
                            <condition>
                                <macro>{#DB}</macro>
                                <value>{$CLICKHOUSE.LLD.FILTER.DB.MATCHES}</value>
                                <formulaid>A</formulaid>
                            </condition>
                            <condition>
                                <macro>{#DB}</macro>
                                <value>{$CLICKHOUSE.LLD.FILTER.DB.NOT_MATCHES}</value>
                                <operator>NOT_MATCHES_REGEX</operator>
                                <formulaid>B</formulaid>
                            </condition>
                        </conditions>
                    </filter>
                    <description>Info about replicas</description>
                    <item_prototypes>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Active replicas</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.active_replicas[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Number of replicas of this table that have a session in ZooKeeper (i.e., the number of functioning replicas). (Have a non-zero value only where there is an active session with ZooKeeper).</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].active_replicas.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica future parts</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.future_parts[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Number of data parts that will appear as the result of INSERTs or merges that haven’t been done yet.</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].future_parts.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica queue inserts size</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.inserts_in_queue[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Number of inserts of blocks of data that need to be made.</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].inserts_in_queue.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica readonly</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.is_readonly[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Whether the replica is in read-only mode.&#13;
This mode is turned on if the config doesn’t have sections with ZooKeeper, if an unknown error occurred when reinitializing sessions in ZooKeeper, and during session reinitialization in ZooKeeper.</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <valuemap>
                                <name>Replicas state</name>
                            </valuemap>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].is_readonly.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{min(5m)}=1</expression>
                                    <name>ClickHouse: {#DB}.{#TABLE} Replica is readonly</name>
                                    <priority>WARNING</priority>
                                    <description>This mode is turned on if the config doesn’t have sections with ZooKeeper, if an unknown error occurred when reinitializing sessions in ZooKeeper, and during session reinitialization in ZooKeeper.</description>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica session expired</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.is_session_expired[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>True if the ZooKeeper session expired</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <valuemap>
                                <name>Replicas state</name>
                            </valuemap>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].is_session_expired.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{min(5m)}=1</expression>
                                    <name>ClickHouse: {#DB}.{#TABLE} Replica session is expired</name>
                                    <priority>WARNING</priority>
                                    <description>This mode is turned on if the config doesn’t have sections with ZooKeeper, if an unknown error occurred when reinitializing sessions in ZooKeeper, and during session reinitialization in ZooKeeper.</description>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica lag</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.lag[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <value_type>FLOAT</value_type>
                            <description>Difference between log_max_index and log_pointer</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].replica_lag.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{min(5m)} &gt; {$CLICKHOUSE.LOG_POSITION.DIFF.MAX.WARN}</expression>
                                    <name>ClickHouse: {#DB}.{#TABLE}: Difference between log_max_index and log_pointer is too high (More than {$CLICKHOUSE.LOG_POSITION.DIFF.MAX.WARN} for 5m)</name>
                                    <priority>WARNING</priority>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica log max index</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.log_max_index[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Maximum entry number in the log of general activity. (Have a non-zero value only where there is an active session with ZooKeeper).</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].log_max_index.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica log pointer</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.log_pointer[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Maximum entry number in the log of general activity that the replica copied to its execution queue, plus one. (Have a non-zero value only where there is an active session with ZooKeeper).</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].log_pointer.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica queue merges size</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.merges_in_queue[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Number of merges waiting to be made.</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].merges_in_queue.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica parts to check</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.parts_to_check[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Number of data parts in the queue for verification. A part is put in the verification queue if there is suspicion that it might be damaged.</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].parts_to_check.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica queue size</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.queue_size[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Size of the queue for operations waiting to be performed.</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].queue_size.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{min(5m)}&gt;{$CLICKHOUSE.QUEUE.SIZE.MAX.WARN:&quot;{#TABLE}&quot;}</expression>
                                    <name>ClickHouse: {#DB}.{#TABLE}: Too many operations in queue (over {$CLICKHOUSE.QUEUE.SIZE.MAX.WARN} for 5m)</name>
                                    <priority>WARNING</priority>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Total replicas</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.replica.total_replicas[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Total number of known replicas of this table. (Have a non-zero value only where there is an active session with ZooKeeper).</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: &quot;{#DB}.{#TABLE}&quot; replica status</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].total_replicas.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.replicas</key>
                            </master_item>
                        </item_prototype>
                    </item_prototypes>
                    <trigger_prototypes>
                        <trigger_prototype>
                            <expression>{Template DB ClickHouse by HTTP:clickhouse.replica.active_replicas[&quot;{#DB}.{#TABLE}&quot;].max(5m)} &lt; {Template DB ClickHouse by HTTP:clickhouse.replica.total_replicas[&quot;{#DB}.{#TABLE}&quot;].last()}</expression>
                            <name>ClickHouse: {#DB}.{#TABLE}: Number of active replicas less than number of total replicas</name>
                            <priority>WARNING</priority>
                        </trigger_prototype>
                    </trigger_prototypes>
                    <graph_prototypes>
                        <graph_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica log activity</name>
                            <graph_items>
                                <graph_item>
                                    <color>1A7C11</color>
                                    <item>
                                        <host>Template DB ClickHouse by HTTP</host>
                                        <key>clickhouse.replica.log_max_index[&quot;{#DB}.{#TABLE}&quot;]</key>
                                    </item>
                                </graph_item>
                                <graph_item>
                                    <sortorder>1</sortorder>
                                    <color>2774A4</color>
                                    <item>
                                        <host>Template DB ClickHouse by HTTP</host>
                                        <key>clickhouse.replica.log_pointer[&quot;{#DB}.{#TABLE}&quot;]</key>
                                    </item>
                                </graph_item>
                            </graph_items>
                        </graph_prototype>
                        <graph_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Replica queues</name>
                            <graph_items>
                                <graph_item>
                                    <color>1A7C11</color>
                                    <item>
                                        <host>Template DB ClickHouse by HTTP</host>
                                        <key>clickhouse.replica.merges_in_queue[&quot;{#DB}.{#TABLE}&quot;]</key>
                                    </item>
                                </graph_item>
                                <graph_item>
                                    <sortorder>1</sortorder>
                                    <color>2774A4</color>
                                    <item>
                                        <host>Template DB ClickHouse by HTTP</host>
                                        <key>clickhouse.replica.inserts_in_queue[&quot;{#DB}.{#TABLE}&quot;]</key>
                                    </item>
                                </graph_item>
                                <graph_item>
                                    <sortorder>2</sortorder>
                                    <color>F63100</color>
                                    <item>
                                        <host>Template DB ClickHouse by HTTP</host>
                                        <key>clickhouse.replica.queue_size[&quot;{#DB}.{#TABLE}&quot;]</key>
                                    </item>
                                </graph_item>
                                <graph_item>
                                    <sortorder>3</sortorder>
                                    <color>A54F10</color>
                                    <item>
                                        <host>Template DB ClickHouse by HTTP</host>
                                        <key>clickhouse.replica.future_parts[&quot;{#DB}.{#TABLE}&quot;]</key>
                                    </item>
                                </graph_item>
                                <graph_item>
                                    <sortorder>4</sortorder>
                                    <color>FC6EA3</color>
                                    <item>
                                        <host>Template DB ClickHouse by HTTP</host>
                                        <key>clickhouse.replica.parts_to_check[&quot;{#DB}.{#TABLE}&quot;]</key>
                                    </item>
                                </graph_item>
                            </graph_items>
                        </graph_prototype>
                    </graph_prototypes>
                    <master_item>
                        <key>clickhouse.replicas</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#DB}</lld_macro>
                            <path>$.database</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#TABLE}</lld_macro>
                            <path>$.table</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                </discovery_rule>
                <discovery_rule>
                    <name>Tables</name>
                    <type>DEPENDENT</type>
                    <key>clickhouse.tables.discovery</key>
                    <delay>0</delay>
                    <filter>
                        <evaltype>AND</evaltype>
                        <conditions>
                            <condition>
                                <macro>{#DB}</macro>
                                <value>{$CLICKHOUSE.LLD.FILTER.DB.MATCHES}</value>
                                <formulaid>A</formulaid>
                            </condition>
                            <condition>
                                <macro>{#DB}</macro>
                                <value>{$CLICKHOUSE.LLD.FILTER.DB.NOT_MATCHES}</value>
                                <operator>NOT_MATCHES_REGEX</operator>
                                <formulaid>B</formulaid>
                            </condition>
                        </conditions>
                    </filter>
                    <description>Info about tables</description>
                    <item_prototypes>
                        <item_prototype>
                            <name>ClickHouse: {#DB}: Bytes</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.db.bytes[&quot;{#DB}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <units>B</units>
                            <description>Database size in bytes.</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: DB &quot;{#DB}&quot;</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot;)].bytes.sum()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.tables</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Bytes</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.table.bytes[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <units>B</units>
                            <description>Table size in bytes. Database: {#DB}, table: {#TABLE}</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: Table &quot;{#DB}.{#TABLE}&quot;</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].bytes.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.tables</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Parts</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.table.parts[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Number of parts of the table. Database: {#DB}, table: {#TABLE}</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: Table &quot;{#DB}.{#TABLE}&quot;</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].parts.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.tables</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>ClickHouse: {#DB}.{#TABLE}: Rows</name>
                            <type>DEPENDENT</type>
                            <key>clickhouse.table.rows[&quot;{#DB}.{#TABLE}&quot;]</key>
                            <delay>0</delay>
                            <history>7d</history>
                            <description>Number of rows in the table. Database: {#DB}, table: {#TABLE}</description>
                            <application_prototypes>
                                <application_prototype>
                                    <name>ClickHouse: Table &quot;{#DB}.{#TABLE}&quot;</name>
                                </application_prototype>
                            </application_prototypes>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$[?(@.database == &quot;{#DB}&quot; &amp;&amp; @.table == &quot;{#TABLE}&quot;)].rows.first()</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>clickhouse.tables</key>
                            </master_item>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>clickhouse.tables</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#DB}</lld_macro>
                            <path>$.database</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#TABLE}</lld_macro>
                            <path>$.table</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                </discovery_rule>
            </discovery_rules>
            <macros>
                <macro>
                    <macro>{$CLICKHOUSE.DELAYED.FILES.DISTRIBUTED.COUNT.MAX.WARN}</macro>
                    <value>600</value>
                    <description>Maximum size of distributed files queue to insert for trigger expression.</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.DELAYED.INSERTS.MAX.WARN}</macro>
                    <value>0</value>
                    <description>Maximum number of delayed inserts for trigger expression.</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.LLD.FILTER.DB.MATCHES}</macro>
                    <value>.*</value>
                    <description>Filter of discoverable databases</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.LLD.FILTER.DB.NOT_MATCHES}</macro>
                    <value>CHANGE_IF_NEEDED</value>
                    <description>Filter to exclude discovered databases</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.LLD.FILTER.DICT.MATCHES}</macro>
                    <value>.*</value>
                    <description>Filter of discoverable dictionaries</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.LLD.FILTER.DICT.NOT_MATCHES}</macro>
                    <value>CHANGE_IF_NEEDED</value>
                    <description>Filter to exclude discovered dictionaries</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.LOG_POSITION.DIFF.MAX.WARN}</macro>
                    <value>30</value>
                    <description>Maximum diff between log_pointer and log_max_index.</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.NETWORK.ERRORS.MAX.WARN}</macro>
                    <value>5</value>
                    <description>Maximum number of smth for trigger expression</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.PARTS.PER.PARTITION.WARN}</macro>
                    <value>300</value>
                    <description>Maximum number of parts per partition for trigger expression.</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.PASSWORD}</macro>
                    <value>zabbix_pass</value>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.PORT}</macro>
                    <value>8123</value>
                    <description>The port of ClickHouse HTTP endpoint</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.QUERY_TIME.MAX.WARN}</macro>
                    <value>600</value>
                    <description>Maximum ClickHouse query time in seconds for trigger expression</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.QUEUE.SIZE.MAX.WARN}</macro>
                    <value>20</value>
                    <description>Maximum size of the queue for operations waiting to be performed for trigger expression.</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.REPLICA.MAX.WARN}</macro>
                    <value>600</value>
                    <description>Replication lag across all tables for trigger expression.</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.SCHEME}</macro>
                    <value>http</value>
                    <description>Request scheme which may be http or https</description>
                </macro>
                <macro>
                    <macro>{$CLICKHOUSE.USER}</macro>
                    <value>zabbix</value>
                </macro>
            </macros>
        </template>
    </templates>
    <graphs>
        <graph>
            <name>ClickHouse: Current activity</name>
            <graph_items>
                <graph_item>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.query.current</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.merge.current</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Current connections</name>
            <graph_items>
                <graph_item>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.connections.tcp</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.connections.http</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>2</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>F63100</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.connections.mysql</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>3</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>A54F10</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.connections.interserver</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>4</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>FC6EA3</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.connections.distribute</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Distributed</name>
            <graph_items>
                <graph_item>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.distributed.files.retry.rate</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.distributed.files.fail.rate</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>2</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>F63100</color>
                    <yaxisside>RIGHT</yaxisside>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.distributed.files</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Insert/Merge bytes rate</name>
            <graph_items>
                <graph_item>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.inserted_bytes.rate</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.merge_bytes.rate</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Insert/Merge rows rate</name>
            <graph_items>
                <graph_item>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.inserted_rows.rate</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.merge_rows.rate</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Memory Usage</name>
            <graph_items>
                <graph_item>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.memory.tracking.merges</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.memory.tracking.schedule.pool</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>2</sortorder>
                    <color>F63100</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.memory.tracking.background.moves</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>3</sortorder>
                    <color>A54F10</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.memory.tracking.background</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>4</sortorder>
                    <color>FC6EA3</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.memory.tracking</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Memory Utilization</name>
            <graph_items>
                <graph_item>
                    <drawtype>GRADIENT_LINE</drawtype>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.jemalloc.allocated</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <drawtype>GRADIENT_LINE</drawtype>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.jemalloc.resident</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>2</sortorder>
                    <drawtype>GRADIENT_LINE</drawtype>
                    <color>F63100</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.jemalloc.mapped</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Queries rate</name>
            <graph_items>
                <graph_item>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.query.rate</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.select_query.rate</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>2</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>F63100</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.insert_query.rate</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Syscalls in fly</name>
            <graph_items>
                <graph_item>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.read</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.write</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Uptime</name>
            <graph_items>
                <graph_item>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.uptime</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
        <graph>
            <name>ClickHouse: Zookeeper exeptions rate</name>
            <graph_items>
                <graph_item>
                    <color>1A7C11</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.zookeper.exeptions.rate</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>1</sortorder>
                    <color>2774A4</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.zookeper.hw_exeptions.rate</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>2</sortorder>
                    <color>F63100</color>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.zookeper.user_exeptions.rate</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>3</sortorder>
                    <drawtype>BOLD_LINE</drawtype>
                    <color>A54F10</color>
                    <yaxisside>RIGHT</yaxisside>
                    <item>
                        <host>Template DB ClickHouse by HTTP</host>
                        <key>clickhouse.zookeper.watch</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
    </graphs>
    <value_maps>
        <value_map>
            <name>Replicas state</name>
            <mappings>
                <mapping>
                    <value>0</value>
                    <newvalue>False</newvalue>
                </mapping>
                <mapping>
                    <value>1</value>
                    <newvalue>True</newvalue>
                </mapping>
            </mappings>
        </value_map>
        <value_map>
            <name>Service state</name>
            <mappings>
                <mapping>
                    <value>0</value>
                    <newvalue>Down</newvalue>
                </mapping>
                <mapping>
                    <value>1</value>
                    <newvalue>Up</newvalue>
                </mapping>
            </mappings>
        </value_map>
    </value_maps>
</zabbix_export>
